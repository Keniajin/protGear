library(protGear)
system.file("extdata", "/array_data/machine1/KK2-06.txt", package="protGear")
visualize_slide(
  infile = system.file("extdata", "/array_data/machine1/KK2-06.txt", package="protGear"),
  MFI_var = "B635 Median"
)


## specify the the parameters to process the data
genepix_vars <- array_vars(
  channel = "635",
  chip_path = file.path(system.file("extdata", "array_data/machine1/", package="protGear")),
  totsamples = 21,
  blockspersample = 2,
  mig_prefix = "_first",
  machine = 1,
  ## optional
  date_process = "0520"
)




genepix_vars <- array_vars(
  channel = "635",
  chip_path = file.path(system.file("extdata", "array_data/machine1/", package="protGear")),
  totsamples = 21,
  blockspersample = 2,
  mig_prefix = "_first",
  machine = 1,
  ## optional
  date_process = "0520"
)

data_path <- paste0(genepix_vars$chip_path)
filenames <- list.files(file.path(genepix_vars$chip_path),
                        pattern = "*.txt$|*.gpr$", full.names = F
)
data_files <- purrr::map(
  .x = filenames,
  .f = read_array_files,
  data_path = data_path,
  genepix_vars = genepix_vars
)
data_files <- set_names(data_files, purrr::map(filenames, name_of_files))
names(data_files)
bg <- extract_bg(iden ="KK2-06" , data_files=data_files,genepix_vars=genepix_vars)

readr::write_csv(bg %>% select(-slide),"inst/extdata/bg_example.csv")
plot_bg(bg,
        antigen_name = "antigen",
        bg_MFI = "BG_Median", FG_MFI = "FBG_Median", log = F
)



### Define the genepix_vars
genepix_vars <- array_vars(
  channel = "635",
  chip_path = file.path(system.file("extdata", "array_data/machine1/", package="protGear")),
  totsamples = 21,
  blockspersample = 2,
  mig_prefix = "_first",
  machine = 1,
  ## optional
  date_process = "0520"
)

## the path where the micro-array data is located
data_path <- paste0(genepix_vars$chip_path)
filenames <- list.files(file.path(genepix_vars$chip_path),
                        pattern = "*.txt$|*.gpr$", full.names = F
)
## create a list of all the files
data_files <- purrr::map(
  .x = filenames,
  .f = read_array_files,
  data_path = data_path,
  genepix_vars = genepix_vars
)
data_files <- set_names(data_files, purrr::map(filenames, name_of_files))

merge_sampleID(iden = "KK2-06", data_files = data_files,
               genepix_vars =genepix_vars,method = "subtract_global" )
readr::write_csv(df_1,"inst/extdata/Data1_sample.csv")

readr::write_csv(Data1,"inst/extdata/Data1_bg_sample.csv")



## buffers
 bg_correct_df <- readr::read_csv(system.file("extdata", "Data1_sample.csv", package="protGear"))
aa <- buffer_spots(Data1 = bg_correct_df)
readr::write_csv(aa %>% mutate(.id="slideid"),"inst/extdata/buffers_sample2.csv")

buffers <- readr::read_csv(system.file("extdata", "buffers_sample2.csv", package="protGear"))
plot_buffer(df=buffers,buffer_names = "sampleID")
